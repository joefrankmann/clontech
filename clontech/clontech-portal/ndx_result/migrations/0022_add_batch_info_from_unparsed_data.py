# -*- coding: utf-8 -*-
# Generated by Django 1.11.5 on 2017-09-18 13:00
from __future__ import unicode_literals

import json

from django.db import migrations


def forwards(apps, schema_editor):
    Result = apps.get_model('ndx_result', 'Result')  # noqa
    Batch = apps.get_model('ndx_batch', 'Batch')  # noqa

    for result in Result.objects.filter(batch=None).exclude(unparsed_data='').select_for_update():
        try:
            unparsed_data = json.loads(result.unparsed_data)
            batch_no = unparsed_data.pop('BatchID')
            batch = Batch.objects.get(lot_no=batch_no)
        except (KeyError, json.decoder.JSONDecodeError, Batch.DoesNotExist):
            continue
        result.batch = batch
        result.unparsed_data = json.dumps(unparsed_data)
        result.save()


def backwards(apps, schema_editor):
    Result = apps.get_model('ndx_result', 'Result')  # noqa
    Batch = apps.get_model('ndx_batch', 'Batch')  # noqa

    for result in Result.objects.exclude(batch=None).select_for_update():
        batch = result.batch
        try:
            unparsed_data = json.loads(result.unparsed_data)
        except json.decoder.JSONDecodeError:
            unparsed_data = {}
        unparsed_data['BatchID'] = batch.lot_no
        result.unparsed_data = json.dumps(unparsed_data)
        result.batch = None
        result.save()


class Migration(migrations.Migration):

    dependencies = [
        ('ndx_result', '0021_resultgeolocation'),
        ('ndx_batch', '0002_auto_20170531_1123'),
    ]

    operations = [
        migrations.RunPython(forwards, backwards),
    ]
