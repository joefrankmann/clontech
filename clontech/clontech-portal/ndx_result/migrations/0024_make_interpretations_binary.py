# -*- coding: utf-8 -*-
# Generated by Django 1.11.5 on 2017-09-20 17:48
from __future__ import unicode_literals

import json

from django.db import migrations


def forwards(apps, schema_editor):
    Result = apps.get_model('ndx_result', 'Result')  # noqa

    for result in Result.objects.exclude(interpretation__in=('Valid', 'Invalid')).select_for_update():
        unparsed_data = json.loads(result.unparsed_data)
        if '__migration_0024_interpretation' in unparsed_data:
            raise Exception("Inconsistent data: result has __migration_0024_interpretation in unparsed_data.")
        unparsed_data['__migration_0024_interpretation'] = result.interpretation
        result.interpretation = 'Valid'
        result.unparsed_data = json.dumps(unparsed_data)
        result.save()


def backwards(apps, schema_editor):
    Result = apps.get_model('ndx_result', 'Result')  # noqa

    for result in Result.objects.filter(interpretation='Valid').exclude(unparsed_data='').select_for_update():
        unparsed_data = json.loads(result.unparsed_data)
        try:
            result.interpretation = unparsed_data.pop('__migration_0024_interpretation')
        except KeyError:
            continue
        result.unparsed_data = json.dumps(unparsed_data)
        result.save()


class Migration(migrations.Migration):

    dependencies = [
        ('ndx_result', '0023_auto_20170920_1710'),
    ]

    operations = [
        migrations.RunPython(forwards, backwards),
    ]
